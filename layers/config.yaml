integrations:
  slack:
    baseChannelId: &baseChannelId C0606T6A3B5
    channelPrefix: inc_
  datastore:
    type: dynamodb
    region: ap-northeast-1
    tableName: incident

definitions:
  service:
    name: サービス
    items: &serviceOptions
      appA:
        label: アプリケーションA
      appB:
        label: アプリケーションB
      appC:
        label: アプリケーションC
      all:
        label: 全サービス
  triage:
    name: 温度感
    items: &triageOptions
      emergency:
        label: ":fire: サービスに影響が出ており、緊急の対応が必要"
      investigate:
        label: ":mag: サービスに影響が出ている可能性があり、調査が必要"
      maintenance:
        label: ":wrench: 現時点でサービスに影響はないが、予防措置を取る"
  severity:
    name: インシデントレベル
    items: &severityOptions
      critical:
        label: ":police-car-light: Critical"
      major:
        label: ":prohibited: Major"
      minor:
        label: ":warning: Minor"
flow:
  trigger:
    type: slack/command
    invoke: openInitialForm
  functions:
    - name: openInitialForm
      action: slack/openModal
      title: インシデントの疑いを報告
      elements:
        - type: header
          text: インシデントの疑いを報告
        - type: text
          text: インシデントの疑いを報告します。
        - type: checkbox
          elementId: selectService
          label: サービス
          options: *serviceOptions
        - type: radio
          elementId: selectTriage
          label: 温度感
          options: *triageOptions
        - type: textInput
          elementId: incidentDescription
          label: 発生している事象
          placeholder: 決済システムが500エラー
          multiline: true
        - type: note
          text: 今わかっていることをざっくりで構いません
      submit:
        label: 報告
      cancel:
        label: キャンセル
      invoke:
        - initialReport
        - createIncident
        # - createWarRoomChannel
        # - invitePeoples
        # - setPingCycle
    - name: initialReport
      action: slack/post
      channelId: *baseChannelId
      elements:
        - type: header
          text: ":rotating_light: ${{input.values.incidentDescription.value}} (${{input.values.selectTriage.label}})"
        - type: text
          text: <!here> インシデントの疑いが報告されました。
        - type: text
          text: ":fire: ${{input.values.selectTriage.label}}"
        # - type: divider
        - type: note
          text: 以下の情報を確認してください。
        - type: dl
          items:
            "サービス": ${{input.values.selectService.label}}
            "事象": ${{input.values.incidentDescription.value}}
            "報告者": <@${{input.user.id}}>
    - name: createIncident
      action: incident/create
      summary: ${{input.values.incidentDescription.value}}
      reporter:
        id: ${{input.user.id}}
        name: ${{input.user.name}}
      metadata:
        service:
          - label: ${{input.values.selectService.label}}
            value: ${{input.values.selectService.value}}
        triage:
          label: ${{input.values.selectTriage.label}}
          value: ${{input.values.selectTriage.value}}
